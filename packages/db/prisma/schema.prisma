// ---------- Datasource & Generator ----------
generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ---------- Enums ----------
enum PageType {
  PAGE
  POST
}

enum PublishStatus {
  DRAFT
  PUBLISHED
}

enum TaxonomyType {
  CATEGORY
  TAG
}

// Layout / template type for PageForm (STANDARD, HOMEPAGE, LISTING, etc.)
enum PageLayout {
  STANDARD
  HOMEPAGE
  LISTING
  GALLERY
  CONTACT
  LANDING
  REDIRECT
  DOWNLOAD
  CATEGORY_PAGE
  EVENT_PAGE
}

// Listing configuration (for LISTING pages)
enum ListingKind {
  POSTS
  PRODUCTS
  EVENTS
}

// ---------- Auth tables ----------
model Role {
  id    String @id @default(cuid())
  name  String @unique // ADMIN | EDITOR | AUTHOR | SUBSCRIBER
  users User[]
}

model User {
  id     String  @id @default(cuid())
  name   String?
  email  String? @unique
  image  String?
  roleId String?
  role   Role?   @relation(fields: [roleId], references: [id])

  accounts  Account[]
  sessions  Session[]
  Page      Page[]
  Media     Media[]
  revisions PageRevision[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Account {
  id                String    @id @default(cuid())
  userId            String
  type              String?
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        DateTime?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  password          String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  ipAddress    String?
  userAgent    String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ---------- CMS Content ----------
model Page {
  id      String        @id @default(cuid())
  type    PageType
  status  PublishStatus @default(DRAFT)
  slug    String        @unique
  title   String
  excerpt String?
  content String // HTML

  // Layout / template (corresponds to PageForm.type)
  layout PageLayout @default(STANDARD)

  // Cover image
  coverId String?
  cover   Media?  @relation(fields: [coverId], references: [id])

  // Author + publish metadata
  authorId    String?
  author      User?     @relation(fields: [authorId], references: [id])
  publishedAt DateTime?

  // Menu placement
  inHeaderMenu Boolean @default(false)
  inFooterMenu Boolean @default(false)

  // Hierarchy
  parentId String?
  parent   Page?   @relation("ChildPages", fields: [parentId], references: [id])
  children Page[]  @relation("ChildPages")

  // Taxonomies
  taxonomies PageOnTaxonomy[]

  // Listing config (for LISTING layout)
  listingKind       ListingKind?
  listingTaxonomyId String?
  listingTaxonomy   Taxonomy?    @relation(fields: [listingTaxonomyId], references: [id])

  // Event-specific fields (for EVENT_PAGE layout)
  eventStart      DateTime?
  eventEnd        DateTime?
  eventLocation   String?
  registrationUrl String?

  // Redirect (for REDIRECT layout)
  redirectTo String?

  // Gallery (ordered media)
  gallery PageMedia[]

  // Basic page/post statistics
  viewCount       Int       @default(0)
  uniqueViewCount Int       @default(0)
  likeCount       Int       @default(0)
  lastViewedAt    DateTime?

  // Revision history
  revisions PageRevision[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Media {
  id           String  @id @default(cuid())
  url          String // e.g. /uploads/... or S3 URL
  key          String? // S3/MinIO object key
  mime         String
  width        Int?
  height       Int?
  alt          String?
  uploadedById String?
  uploadedBy   User?   @relation(fields: [uploadedById], references: [id])

  createdAt DateTime @default(now())

  PageMedia PageMedia[]
  Page      Page[]
}

model Taxonomy {
  id   String       @id @default(cuid())
  type TaxonomyType
  slug String       @unique
  name String

  pages PageOnTaxonomy[]
  Page  Page[]
}

model PageOnTaxonomy {
  pageId     String
  taxonomyId String

  page     Page     @relation(fields: [pageId], references: [id], onDelete: Cascade)
  taxonomy Taxonomy @relation(fields: [taxonomyId], references: [id], onDelete: Cascade)

  @@id([pageId, taxonomyId])
}

model PageMedia {
  pageId  String
  mediaId String
  sort    Int    @default(0)

  page  Page  @relation(fields: [pageId], references: [id], onDelete: Cascade)
  media Media @relation(fields: [mediaId], references: [id], onDelete: Cascade)

  @@id([pageId, mediaId])
}

model PageRevision {
  id     String @id @default(cuid())
  pageId String
  page   Page   @relation(fields: [pageId], references: [id], onDelete: Cascade)

  authorId String?
  author   User?   @relation(fields: [authorId], references: [id])

  title       String
  slug        String
  excerpt     String?
  content     String
  layout      PageLayout
  status      PublishStatus
  publishedAt DateTime?

  note String?

  createdAt DateTime @default(now())

  @@index([pageId, createdAt])
}
